{% extends "cabinet/cabinet_layout.html.twig" %}

    {% set title= "Order Edit" %}
    {% if page_title is defined and page_title is not empty %}
        {% set title=page_title %}
    {% endif %}

{% block title %}{{title|trans }}{% endblock %}

{% block content %}
        <div class="col-12 col-xl-12">
            <div class="card card-default">
                <div class="card-header">
                    <div class="card-title">{{title|trans }}</div>
                </div>
                <div class="card-body">
                    {%
                        form_theme form
                        "system/product-order-theme.html.twig"
                        "system/jquery.collection.html.twig"
                    %}
                    {{  form_errors(form) }}

                    {{ form_start(form, {"method": "POST", "attr": {"id": "orderForm","class":"mb-3"}}) }}
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    {{ form_label(form.orderType,"OrderType"|trans, {
                                        "label_attr": {"class": "text-muted"}
                                    }) }}
                                    {{ form_widget(form.orderType) }}


                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    {{ form_label(form.trackingNumber,"trackingNumber"|trans, {
                                        "label_attr": {"class": "text-muted"}
                                    }) }}
                                    <div class="input-group with-focus ">
                                        {% if form.trackingNumber.vars.errors|length %}
                                            {{ form_widget(form.trackingNumber, {"attr": {"class": "is-invalid form-control border-right-0"}}) }}
                                        {% else %}
                                            {{ form_widget(form.trackingNumber) }}
                                        {% endif %}
                                        <div class="input-group-append">
                                 <span class="input-group-text text-muted bg-transparent border-left-0">
                                     <em class="fa fa-user"></em>
                                 </span>
                                        </div>
                                        <div class="invalid-feedback">{{ form_errors(form.trackingNumber) }}</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
{#                                <div class="form-group">#}
{#                                    {{ form_label(form.shipDate,"shipDate"|trans, {#}
{#                                        "label_attr": {"class": "text-muted"}#}
{#                                    }) }}#}
{#                                    <div class="input-group with-focus ">#}
{#                                        {% if form.shipDate.vars.errors|length %}#}
{#                                            {{ form_widget(form.shipDate, {"attr": {"class": "is-invalid form-control border-right-0"}}) }}#}
{#                                        {% else %}#}
{#                                            {{ form_widget(form.shipDate) }}#}
{#                                        {% endif %}#}
{#                                        <div class="input-group-append input-group-addon">#}
{#                                 <span class="input-group-text text-muted bg-transparent border-left-0">#}
{#                                     <em class="fa fa-user"></em>#}
{#    #}
{#                                 </span>#}
{#                                        </div>#}
{#                                        <div class="invalid-feedback">{{ form_errors(form.shipDate) }}</div>#}
{#                                    </div>#}
{#                                </div>#}
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <div class="form-group">
                                    {{ form_label(form.products,"Content"|trans, {
                                        "label_attr": {"class": "text-muted"}
                                    }) }}
                                    <div class="with-focus">
                                        {{ form_widget(form.products) }}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-9">
                                <div class="form-group">
                                    {{ form_label(form.addresses,"Address"|trans, {
                                        "label_attr": {"class": "text-muted"}
                                    }) }}
                                    <div class="input-group with-focus ">
                                        {% if form.addresses.vars.errors|length %}
                                            {{ form_widget(form.addresses, {"attr": {"class": "is-invalid custom-select custom-select-mb"}}) }}
                                        {% else %}
                                            {{ form_widget(form.addresses) }}
                                        {% endif %}
                                        <div class="input-group-append">
                                            <a  id="addAddress" href="#" asss="{{ path("post_address_create") }}" {#target="_blank"#} class="btn btn-outline-info btn-sm">{{ "Add Address" | trans }}
                                            </a>
                                        </div>
                                        <div class="invalid-feedback">{{ form_errors(form.addresses) }}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-3">
                                <div class="form-group">
                                    {{ form_label(form.sendDetailWeight,"sendDetailWeight"|trans, {
                                        "label_attr": {"class": "text-muted"}
                                    }) }}
                                    <div class="input-group with-focus ">
                                        {% if form.sendDetailWeight.vars.errors|length %}
                                            {{ form_widget(form.sendDetailWeight, {"attr": {"class": "is-invalid form-control"}}) }}
                                        {% else %}
                                            {{ form_widget(form.sendDetailWeight) }}
                                        {% endif %}
                                        <div class="invalid-feedback">{{ form_errors(form.sendDetailWeight) }}</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    {{ form_label(form.sendDetailLength,"sendDetailLength"|trans, {
                                        "label_attr": {"class": "text-muted"}
                                    }) }}
                                    <div class="input-group with-focus ">
                                        {% if form.sendDetailLength.vars.errors|length %}
                                            {{ form_widget(form.sendDetailLength, {"attr": {"class": "is-invalid form-control"}}) }}
                                        {% else %}
                                            {{ form_widget(form.sendDetailLength) }}
                                        {% endif %}
                                        <div class="invalid-feedback">{{ form_errors(form.sendDetailLength) }}</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    {{ form_label(form.sendDetailWidth,"sendDetailWidth"|trans, {
                                        "label_attr": {"class": "text-muted"}
                                    }) }}
                                    <div class="input-group with-focus ">
                                        {% if form.sendDetailWidth.vars.errors|length %}
                                            {{ form_widget(form.sendDetailWidth, {"attr": {"class": "is-invalid form-control"}}) }}
                                        {% else %}
                                            {{ form_widget(form.sendDetailWidth) }}
                                        {% endif %}
                                        <div class="invalid-feedback">{{ form_errors(form.sendDetailWidth) }}</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    {{ form_label(form.sendDetailHeight,"sendDetailHeight"|trans, {
                                        "label_attr": {"class": "text-muted"}
                                    }) }}
                                    <div class="input-group with-focus ">
                                        {% if form.sendDetailHeight.vars.errors|length %}
                                            {{ form_widget(form.sendDetailHeight, {"attr": {"class": "is-invalid form-control"}}) }}
                                        {% else %}
                                            {{ form_widget(form.sendDetailHeight) }}
                                        {% endif %}
                                        <div class="invalid-feedback">{{ form_errors(form.sendDetailHeight) }}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group">
                                    {{ form_label(form.shippingCosts,"shippingCosts"|trans, {
                                        "label_attr": {"class": "text-muted"}
                                    }) }}
                                    <div class="input-group with-focus ">
                                        {% if form.shippingCosts.vars.errors|length %}
                                            {{ form_widget(form.shippingCosts, {"attr": {"class": "is-invalid form-control"}}) }}
                                        {% else %}
                                            {{ form_widget(form.shippingCosts) }}
                                        {% endif %}
                                        <div class="invalid-feedback">{{ form_errors(form.shippingCosts) }}</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    {{ form_label(form.volumeWeigth,"volumeWeigth"|trans, {
                                        "label_attr": {"class": "text-muted"}
                                    }) }}
                                    <div class="input-group with-focus ">
                                        {% if form.volumeWeigth.vars.errors|length %}
                                            {{ form_widget(form.volumeWeigth, {"attr": {"class": "is-invalid form-control"}}) }}
                                        {% else %}
                                            {{ form_widget(form.volumeWeigth) }}
                                        {% endif %}
                                        <div class="invalid-feedback">{{ form_errors(form.volumeWeigth) }}</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    {{ form_label(form.declareValue,"declareValue"|trans, {
                                        "label_attr": {"class": "text-muted"}
                                    }) }}
                                    <div class="input-group with-focus ">
                                        {% if form.declareValue.vars.errors|length %}
                                            {{ form_widget(form.declareValue, {"attr": {"class": "is-invalid form-control"}}) }}
                                        {% else %}
                                            {{ form_widget(form.declareValue) }}
                                        {% endif %}
                                        <div class="invalid-feedback">{{ form_errors(form.declareValue) }}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <div class="form-group">
                                    {{ form_label(form.comment,"comment"|trans, {
                                        "label_attr": {"class": "text-muted"}
                                    }) }}
                                    <div class="input-group with-focus ">
                                        {% if form.comment.vars.errors|length %}
                                            {{ form_widget(form.comment, {"attr": {"class": "is-invalid form-control"}}) }}
                                        {% else %}
                                            {{ form_widget(form.comment) }}
                                        {% endif %}

                                        <div class="invalid-feedback">{{ form_errors(form.comment) }}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                                 <div class="offset-4 col-md-2">
                                       {{ form_widget(form.save, {"attr": {"class": "btn btn-block btn-outline-primary mt-3 mx-auto d-block"},"label": "Save"|trans})  }}
                                </div>
                                <div class="col-md-2">
                                    <a href="{{ path("post_parcels") }}" class="btn btn-outline-secondary btn-block mt-3"> {{ "Cancel" | trans }}</a>
                                </div>
                        </div>
                    {{ form_end(form) }}
                </div>
            </div>
        </div>
{% endblock %}
 {% block modal %}
     {# Modal add address #}
     <div class="modal fade" id="addAddressForm" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
         <div class="modal-dialog  modal-lg modal-dialog-centered" role="document">
             <div class="modal-content">
                 <div class="modal-header">
                     <h5 class="modal-title" id="exampleModalLabel">{{ "Data about the address delivery"|trans }}</h5>
                     <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                         <span aria-hidden="true">&times;</span>
                     </button>
                 </div>
                 <div class="modal-body">
                     <div class="d-flex justify-content-center">
                         <div class="spinner-border" role="status">
                             <span class="sr-only">{{ "Loading..." | trans }}</span>
                         </div>
                     </div>
                 </div>
                 <div class="modal-footer">
                     <button type="button" class="btn btn-outline-secondary" data-dismiss="modal">{{ "Close" | trans }}</button>
                     <button type="button" id="saveaddress" class="btn btn-outline-primary">{{ "Save changes" | trans }}</button>
                 </div>
             </div>
         </div>
     </div>
 {% endblock %}
 {% block javascripts %}
     <script src="{{ asset("sklad-express/js/jquery.collection.js") }}"></script>
<script>
     jQuery(".datepicker").datepicker({
        uiLibrary: "bootstrap4",
        autoclose: true,
        language: 'ru'
     });



    $(".product-list").collection({
        "allow_up": false,
        "allow_down": false,
        "add": "<a href='#' class='btn btn-outline-success btn-add-products'>{{ "Add product" | trans }}</a>",
        "add_at_the_end": true
     });

     $(document).ready(function(){
         $('body').on('click','#addAddress',function(){

             $('#addAddressForm .modal-body').html('<div class="d-flex justify-content-center">' +
                 '<div class="spinner-border" role="status">'+
                 '<span class="sr-only">{{ "Loading..." | trans }}</span>'+
                 '</div></div>');

             $('#addAddressForm .modal-body').load('{{ path("ajax_post_address_create") }}',function(result){
                 $('#addAddressForm').modal({show:true});
                 $('form').on('keyup','#address_form_ajax_city'
                     + ',#address_form_ajax_street'
                     + ',#address_form_ajax_house'
                     + ',#address_form_ajax_regionOblast'
                     + ',#address_form_ajax_zip'
                     + ',#address_form_ajax_apartment'
                     + ',#address_form_ajax_userFirstName'
                     + ',#address_form_ajax_userLastName'
                     + ',#address_form_ajax_phone'
                     + ',#address_form_ajax_aliasOfAddress'

                     ,function () {
                         var pattern = new RegExp('^([a-zA-Z0-9\\.\\,\\@,\\s]+)$'),
                             el =$(this).closest('.form-group');
                         var massege_1 ="Пишите только на латыни.";
                         if($('button[data-id=select_language]').attr('title')[0] == 'У'){
                             massege_1 ="Пишіть тільки на латині.";
                         }
                         if(!pattern.test( $(this).val())){
                             if(!el.find('span.text-danger')[0]){
                                 el.append('<span class="message_error text-danger">'+massege_1+'</span>');
                             }else{
                                 el.find('.text-danger').text(massege_1);
                             }
                             $("button#saveaddress").addClass('disabled').attr({"disabled":true}).css({"cursor":"not-allowed"});
                         }else {
                             el.find('span.text-danger').remove();
                             if(!$('body').find('span.text-danger')[0]){
                                 $("button#saveaddress").removeClass('disabled').attr({"disabled":false}).css({"cursor":"pointer"});
                             }

                         }
                     });
             });
             $('#addAddressForm').modal({show:true});
             console.log($('#addAddressForm .modal-body'));return false;


         });

         $('body').on('click','#saveaddress',function(){
             var senddata=$("#addressForm").serialize();
             $.ajax({
                 url: '{{ path("ajax_post_address_create") }}',
                 type: 'POST',
                 data: senddata,
                 success: function(mess) {
                     if (mess && typeof mess === "object") {
                         console.log(mess);
                         $('option', $("#order_form_addresses")).remove();
                         $.each(mess, function(key, value) {
                             console.log(value);
                             $('#order_form_addresses').append('<option value="' + key + '">' + value + '</option>');
                         });
                         $('#order_form_addresses').prop('selected', true);
                         $('#addAddressForm').modal('hide');
                     }
                    else{
                         $('#addAddressForm .modal-body').html(mess);
                     }

                     //$('#myModal').modal('hide');
                 },
                 error:function(mess) {
                     console.log(mess);
                 }
             })
         });



         {#
         $("#save").click(function(){
             $.ajax({
                 url: '{{ path{"ajax_post_address_create"} }}',
                 type: 'POST',
                 success: function(res) {
                     $('#myModal').modal('hide');
                 },
                 error: function(error) {
                     $('#myModal').modal('hide');
                     console.log(error);
                 }
             })
         });
         #}

         $('#order_form_orderType , #order_form_addresses').change(function () {
                check();
         });

         $('form').on('keyup',"#order_form_sendDetailLength" +
             ",#order_form_sendDetailWidth" +
             ",#order_form_sendDetailHeight" +
             ",#order_form_products_0_price" +
             ",#order_form_products_0_count" +
             ",#order_form_sendDetailWeight" +
             ",#order_form_addresses"
             ,function () {
                 check()
             });
         function check() {
             console.log(33);

                 var resReturn=0,
                     volume=0,
                     weight=($('#order_form_sendDetailWeight').val())?$('#order_form_sendDetailWeight').val():'0',
                     s1=($('#order_form_sendDetailWidth').val())?$('#order_form_sendDetailWidth').val():'0',
                     s2=($('#order_form_sendDetailHeight').val())?$('#order_form_sendDetailHeight').val():'0',
                     s3=($('#order_form_sendDetailLength').val())?$('#order_form_sendDetailLength').val():'0';
                 volume= (s1*s2*s3/5000).toFixed(3);
                 var resW=(Number(weight)>Number(volume))?weight:volume,
                        Vip = $('#order_form_userVip').val();
                    if(
                        (weight == 0) ||
                        (s1==0) ||
                        (s2==0) ||
                        (s3==0) ){
                        console.log(weight);
                        console.log(s1);
                        console.log(s2);
                        console.log(s3);
                        console.log('err!');
                        return false;
                    }
                     $('#order_form_volumeWeigth').val(volume);
                     $('#order_form_declareValue').val($('#order_form_products_0_price').val());
                     var Express = 0;
                     if($('#order_form_orderType option:selected').val() == 2) {
                         Express = 1;
                     }
                     $.ajax({
                         url: '{{ path("dhl_price") }}',
                         type: 'get',
                         // dataType:'json',
                         data: {'id_adress':$('#order_form_addresses option:selected','').val(),
                         'Height':s2,
                         'Length':s3,
                         'Width':s1,
                         'Weight':weight,
                         'Express':Express,
                         'Vip':Vip,
                         },
                         success: function(res) {
                             console.log(res);
                             if(res == false){
                                 $('#order_form_shippingCosts').val('-');
                                 return true;
                             }
                             $('#order_form_shippingCosts').val(res);
                             return true;
                         },
                         error: function(xhr, ajaxOptions, thrownError) {
                             console.log(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
                             $('#order_form_shippingCosts').val('-');

                         }
                     });
                 // var message = "Для розрахунку вартості оберить тип доставки \"Тип доставки\" ";
                 // if($('button[data-id=select_language]').attr('title')[0] == 'Р'){
                 //     message ="Для расчета стоимости выберите  \"Тип доставки\"";
                 // }
                 // if($('#order_form_orderType option:selected').val() == 1){
                 //     message = WithCost;
                 // };
                 // if($('#order_form_orderType option:selected').val() == 2){
                 //     message = "Экспресс доставки автоматично розрахувати неможливо.";
                 //     if($('button[data-id=select_language]').attr('title')[0] == 'Р'){
                 //         message ="Экспресс доставки автоматически рассчитать невозможно.";
                 //     }
                 // };
                 // if($('#order_form_orderType option:selected').val() == 1) {
                 //     $('#order_form_shippingCosts').val(WithCost);
                 // }

             };
     });
</script>
 {% endblock %}
